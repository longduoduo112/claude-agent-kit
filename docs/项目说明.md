# 项目说明（claude-agent-kit）

本文档面向首次接触本仓库的开发者，说明“它能做什么、怎么跑、核心流程与关键技术点”，并重点解释 **目录路径、会话路径、子进程（Claude Code）** 这三类容易踩坑的机制。

---

## 1. 项目定位与目标

`claude-agent-kit` 是围绕 `@anthropic-ai/claude-agent-sdk` 的一套工程化封装与示例集合，目标是把「Claude Code/Agent 的流式对话、工具调用、会话续聊、多客户端实时 UI」落到可复用的代码结构里。

你可以把它理解为三层：

1. **基础能力层**（`packages/`）：会话管理、消息解析、WebSocket 编排。
2. **示例应用层**（`examples/`）：可直接运行的端到端示例，其中 `examples/claude-code-web` 是重点（Express + Vite + ws）。
3. **文档/参考层**（`docs/`）：权限模式、会话管理、流式输入等说明。

---

## 2. 主要功能（你能用它做什么）

### 2.1 会话生命周期与流式输出

- 以 `Session` 表示一次 Claude Code 会话，管理消息列表、busy/loading 状态、resume、错误等。
- 以 `SessionManager` 维护多个 `Session`，并把 WebSocket 客户端订阅到对应会话。
- 支持 Claude Code “stream-json” 输出风格的流式消息（边生成边推送到 UI）。

### 2.2 WebSocket 多客户端实时体验

- 浏览器通过 `ws` 与服务端通信，发送 `chat / resume / setSDKOptions` 等消息类型。
- 服务端把 SDK 输出的 `message_added / messages_updated / session_state_changed` 推送给前端渲染。

### 2.3 MCP（Model Context Protocol）与文件系统能力

- `examples/claude-code-web` 支持读取项目根目录的 `.mcp.json`，加载 MCP Server。
- 默认内置 `workspace-filesystem`（受限文件系统 MCP），用于让 Claude 安全地读写你允许的目录。

### 2.4 “New Project”/工作区管理（Web 示例）

`examples/claude-code-web` 提供 “New Project” 创建目录的 API，并在 UI 中展示/切换项目。

近期对路径语义做了明确分离（避免历史上“项目目录建在 agent 里”）：

- `WORKSPACE_DIR`：默认 `<project>/agent`，主要用于保存 Claude Code 的 `.claude/` 数据（会话、debug、skills 等）。
- `WORKSPACES_DIR`：默认 `<project>/workspaces`，用于创建用户的“新项目/新工作区”目录。
- `PROJECT_ROOT`：服务端启动目录（`examples/claude-code-web` 的根），用于 `.mcp.json` 模板展开与工具根目录。

---

## 3. 目录结构（快速定位）

### 3.1 Monorepo 结构

- `packages/messages/`：消息结构与工具输出解析/归一化（面向 UI 与日志）。
- `packages/server/`：`Session`、`SessionManager`、`SimpleClaudeAgentSDKClient` 等核心后端封装。
- `packages/websocket/`：WebSocket Handler 与 Client 适配。
- `examples/claude-code-web/`：Web 示例（Express + Vite + React + ws），用于验证端到端流程。
- `docs/reference/`：参考文档（权限、会话、流式输入等）。

### 3.2 Web 示例关键目录（`examples/claude-code-web/`）

- `src/server/`：Express 服务端、API、路由、MCP 配置加载。
- `src/client/`：React 前端（会话列表、消息渲染、输入框、权限模式切换等）。
- `agent/`：默认的“Claude Home”，会写入 `agent/.claude/*`（会话、debug、skills、shell snapshot 等）。
- `workspaces/`：默认的新项目创建目录。

---

## 4. 关键技术机制（重点：路径/会话/子进程）

### 4.1 Claude Code 子进程是谁、怎么启动的？

`@anthropic-ai/claude-agent-sdk` 在内部会 `spawn` 一个 Claude Code CLI（Node 版 `cli.js` 或 native binary），并用 stdin/stdout 进行 `stream-json` 交互。

在 `examples/claude-code-web` 中，服务端会把 `executable` 设为 `process.execPath`（当前 Node 的绝对路径），避免 Windows 下因 `PATH` 不完整导致 `spawn node ENOENT`。

相关实现：`examples/claude-code-web/src/server/server.ts:65`、`packages/server/src/server/simple-cas-client.ts:89`。

### 4.2 会话持久化“按 cwd 分桶”的事实

Claude Code 的 session 持久化目录是：

`<CLAUDE_HOME>/.claude/projects/<sanitize(cwd)>/<sessionId>.jsonl`

其中 `<sanitize(cwd)>` 由 cwd 路径计算得出（例如 `E:\a\b` 会变成某个 `E--a-b` 的目录名）。这意味着：

- **同一个 `sessionId`，如果你用不同的 `cwd` 去 `--resume`，Claude Code 可能会在另一个桶里找不到它。**
- 表现为 CLI stderr：`No conversation found with session ID: ...`，随后进程以非 0 退出（常见 `code=1`）。

这也是 Web 端“第一次对话正常，追加对话后失败”的典型根因：第一次创建会话时的 `cwd` 与后续续聊时传入的 `cwd` 不一致。

### 4.3 本仓库对“会话路径/目录迁移”的兼容策略

为减少路径迁移（例如从 `agent/xxx` 移到 `workspaces/xxx`）导致的续聊失败，后端做了两层兜底：

1. **纠偏 cwd**：如果设置的 `cwd` 不存在，尝试在 `WORKSPACES_DIR/`、`PROJECT_ROOT/` 等候选位置寻找同名目录（用于“项目目录移动”场景）。
2. **续聊时优先使用 transcript 中的 cwd**：对已有 `sessionId` 的续聊请求，优先用历史消息里记录的 `cwd` 作为本次 `--resume` 的桶目录，从而保证 Claude Code 能找到会话文件；若历史 cwd 已不存在但可推断新位置，则自动创建目录别名（Windows 下用 junction）以保持兼容。

相关实现：`packages/server/src/server/session.ts:68`、`packages/server/src/server/session.ts:548`。

---

## 5. 核心流程（从 UI 到 Claude Code）

### 5.1 新建项目（工作区）

1. 前端调用 `/api/create-directory` 创建目录。
2. 服务端把目录创建在 `WORKSPACES_DIR`（默认 `<project>/workspaces`）。
3. 前端刷新项目列表并切换当前项目 `cwd`。

### 5.2 新建会话与首轮对话

1. 前端通过 WebSocket 发送 `{ type: 'chat', content, sessionId?: null }`。
2. 服务端为客户端创建新 `Session`，并用默认 SDK options 启动 Claude Code 子进程。
3. 通过 `queryStream` 读到 `system/init`、`assistant`、`result` 等消息，持续推送到前端。

### 5.3 续聊（resume）与追加对话

1. 前端路由中包含 `sessionId`，连接建立后发送 `{ type: 'resume', sessionId }`。
2. 服务端从磁盘加载历史 messages，推送 `messages_updated` 给前端。
3. 用户继续发消息时，服务端对该 `sessionId` 使用 `--resume` 启动 Claude Code。
4. **关键点：续聊必须使用与历史一致的 cwd 桶**，否则会话找不到并退出。

### 5.4 权限模式（plan / acceptEdits）

- `plan`：先给方案/计划，再在获得“批准”后执行。
- `acceptEdits`：更倾向自动修改文件（适合沙盒/受控目录）。

在 plan 模式下，Claude Code 可能会发出 `ExitPlanMode` 这类需要用户确认的工具调用；后端支持发送 tool_result 以批准/拒绝（后续可在 UI 里补齐真正的“批准按钮”）。

相关实现：`packages/server/src/server/session.ts:604`、`packages/websocket/src/websocket-handler.ts:111`、`packages/server/src/types/session.ts:96`。

---

## 6. 运行与配置（开发/生产）

### 6.1 开发模式（推荐）

```bash
pnpm install
cd examples/claude-code-web
npm run dev
```

浏览器打开：`http://localhost:5173`

### 6.2 常用环境变量（Web 示例）

- `ANTHROPIC_API_KEY`：必填（或兼容端点的 token）。
- `ANTHROPIC_BASE_URL` / `ANTHROPIC_API_URL` / `ANTHROPIC_MODEL`：可选（兼容端点/模型）。
- `WORKSPACE_DIR`：默认 `<project>/agent`（Claude Home，保存 `.claude` 数据）。
- `WORKSPACES_DIR`：默认 `<project>/workspaces`（新项目根目录）。
- `PROJECT_ROOT`：默认服务启动目录（通常就是 `examples/claude-code-web`）。
- `DEBUG_CLAUDE_AGENT_SDK=1`：输出 Claude Code 子进程 debug 到 `~/.claude/debug/sdk-*.txt`（排障强力推荐）。

---

## 7. 扩展建议（从示例走向真实业务）

1. **把“工作区目录策略”产品化**：明确“项目创建根”“Claude Home”“可编辑目录”三者的边界，避免混用同一个目录变量。
2. **把 tool_result 前端化**：在 UI 上渲染明确的“批准/拒绝”按钮，而不是依赖用户输入“执行/运行”。
3. **加一层会话迁移工具**：当用户移动目录或重命名项目时，提供“迁移/修复历史会话桶”的命令或 UI。

